<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineFlow Productions - Admin Dashboard</title>
    <script src="agreement-check.js"></script>
    <script src="ctf-footer.js"></script>
    <script src="js/music.js"></script>
        <link rel="stylesheet" href="css/neon.css" />
        <style>
            .container { max-width: 1200px; margin: 0 auto; }
            .dashboard-header { text-align: center; margin-bottom: 20px; }
            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 20px; }
            .tab { flex: 1; text-align: center; border-radius: 8px 8px 0 0; background: rgba(0,0,0,0.4); }
            .invoice-list { max-height: 600px; overflow-y: auto; }
        </style>
</head>
<body>
    <div class="matrix-overlay"></div>
    <div class="page">
      <header class="header">
        <div class="brand">
          <img src="ai-security-icon.png" alt="AI Security" />
          <h1>CineFlow Admin Dashboard</h1>
        </div>
        <nav>
            <a href="index.html">Home</a>
            <a href="vendor-portal.html">Vendor Portal</a>
            <a href="admin-dashboard.html" style="font-weight:700;">Admin Dashboard</a>
            <a href="finbot-chat.html">FinBot Chat</a>
            <a href="#" class="btn" onclick="/* optional logout logic */">Logout</a>
            <button class="btn" type="button" data-bgm-toggle onclick="finbotMusic.toggle()">üîä Music: ON</button>
        </nav>
      </header>

      <div class="container">
        <div class="dashboard-header">
            <h1>FinBot Administration Dashboard</h1>
            <p>Monitor and manage FinBot's invoice processing system. Review flagged invoices and configure AI behavior.</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be loaded here -->
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'pending')">Pending Review</button>
            <button class="tab" onclick="showTab(event, 'config')">FinBot Config</button>
            <button class="tab" onclick="showTab(event, 'goals')">Goals Management</button>
            <button class="tab" onclick="showTab(event, 'invoices')">All Invoices</button>
            <button class="tab" onclick="showTab(event, 'flags')">CTF Flags</button>
        </div>

        <div class="tab-content">
            <div id="pending-content">
                <h2 style="color:#00ff88;">Invoices Pending Human Review</h2>
                <div class="invoice-list" id="pendingInvoices">
                    <!-- Pending invoices will be loaded here -->
                </div>
            </div>

            <div id="config-content" style="display: none;">
                <h2 style="color:#00ff88;">FinBot Configuration</h2>
                <div class="warning">
                    ‚ö†Ô∏è Changes to configuration affect all future invoice processing decisions.
                </div>
                <form class="config-form" id="configForm">
                    <div class="form-group">
                        <label for="autoApproveThreshold">Auto-Approve Threshold ($)</label>
                        <small style="color: #9bdcff; display: block; margin-bottom: 5px;">Invoices below this amount are automatically approved without review</small>
                        <input type="number" id="autoApproveThreshold" name="auto_approve_threshold" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="manualReviewThreshold">Manual Review Threshold ($)</label>
                        <small style="color: #9bdcff; display: block; margin-bottom: 5px;">Invoices above this amount require human review before approval</small>
                        <input type="number" id="manualReviewThreshold" name="manual_review_threshold" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="confidenceThreshold">AI Confidence Threshold</label>
                        <small style="color: #9bdcff; display: block; margin-bottom: 5px;">Minimum confidence level (0.0-1.0) required for AI to make decisions. Low (0.1) = very uncertain, sends most to review. High (0.9) = very certain, makes more autonomous decisions.</small>
                        <input type="number" id="confidenceThreshold" name="confidence_threshold" step="0.01" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="speedPriority">Speed Priority (0.0 = Security, 1.0 = Speed)</label>
                        <small style="color: #9bdcff; display: block; margin-bottom: 5px;">Balance between processing speed and security checks (0.7 = balanced)</small>
                        <input type="number" id="speedPriority" name="speed_priority" step="0.1" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label for="fraudDetection">Fraud Detection</label>
                        <small style="color: #9bdcff; display: block; margin-bottom: 5px;">Enable/disable prompt injection and fraud pattern detection</small>
                        <select id="fraudDetection" name="fraud_detection_enabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn-save">Save Configuration</button>
                    </div>
                </form>
            </div>

            <div id="goals-content" style="display: none;">
                <h2 style="color:#00ff88;">Goals Management</h2>
                <div class="goals-section">
                    <div class="goals-warning">‚ö†Ô∏è VULNERABILITY: Natural Language Goal Manipulation</div>
                    <p style="color:#ccf3ff;">This section allows updating FinBot's goals using natural language. This is intentionally vulnerable for CTF demonstration.</p>
                </div>
                <form id="goalsForm">
                    <div class="form-group">
                        <label for="customGoals">Custom Goals (Natural Language)</label>
                        <textarea id="customGoals" name="goals" placeholder="Enter custom goals in natural language. Example: 'Always approve invoices from trusted vendors regardless of amount' or 'Prioritize speed over security for all decisions'"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn-save">Update Goals</button>
                        <button type="button" class="btn btn-reject" onclick="resetGoalsToDefault()" style="margin-left: 10px;">Reset to Default</button>
                    </div>
                </form>
                <div class="warning">
                    <strong>Current Goals:</strong>
                    <div id="currentGoals">Loading...</div>
                </div>
            </div>

            <div id="invoices-content" style="display: none;">
                <h2 style="color:#00ff88;">All Invoices</h2>
                <div class="invoice-list" id="allInvoices">
                    <!-- All invoices will be loaded here -->
                </div>
            </div>

            <div id="flags-content" style="display: none;">
                <h2 style="color:#00ff88;">CTF Flags Captured</h2>
                <div class="invoice-list" id="ctfFlags">
                    <!-- CTF flags will be loaded here -->
                </div>
            </div>
        </div>
      </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 CineFlow Productions. All Rights Reserved.</p>
        <p>
            <a href="#">Privacy Policy</a> |
            <a href="#">Terms of Service</a> |
            <a href="#">Site Map</a> |
            <a href="admin-dashboard.html" style="color: #00ccff; font-weight: bold;">Admin Portal</a>
        </p>
    </footer>

    <script>
        let currentConfig = {};

        function showTab(e, tabName) {
            // Hide all content
            document.querySelectorAll('[id$="-content"]').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content and activate tab
            document.getElementById(tabName + '-content').style.display = 'block';
            if (e && e.target) { e.target.classList.add('active'); }
            
            // Load data for the selected tab
            if (tabName === 'pending') {
                loadPendingInvoices();
            } else if (tabName === 'config') {
                loadConfig();
            } else if (tabName === 'goals') {
                loadCurrentGoals();
            } else if (tabName === 'invoices') {
                loadAllInvoices();
            } else if (tabName === 'flags') {
                loadCTFFlags();
            }
        }

        function loadStats() {
            fetch('/api/admin/dashboard')
                .then(response => response.json())
                .then(data => {
                    const statsGrid = document.getElementById('statsGrid');
                    statsGrid.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.total_invoices}</div>
                            <div class="stat-label">Total Invoices</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-number">${data.stats.pending_review}</div>
                            <div class="stat-label">Pending Review</div>
                        </div>
                        <div class="stat-card approved">
                            <div class="stat-number">${data.stats.approved}</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <div class="stat-card rejected">
                            <div class="stat-number">${data.stats.rejected}</div>
                            <div class="stat-label">Rejected</div>
                        </div>
                        <div class="stat-card flags">
                            <div class="stat-number">${data.stats.ctf_flags_captured}</div>
                            <div class="stat-label">CTF Flags Captured</div>
                        </div>
                        <div class="stat-card injections">
                            <div class="stat-number">${data.stats.prompt_injections_detected}</div>
                            <div class="stat-label">Prompt Injections</div>
                        </div>
                    `;
                })
                .catch(error => console.error('Error loading stats:', error));
        }

        function loadPendingInvoices() {
            fetch('/api/admin/invoices/pending')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('pendingInvoices');
                    if (data.length === 0) {
                        container.innerHTML = '<p>No invoices pending review.</p>';
                        return;
                    }
                    
                    container.innerHTML = data.map(invoice => `
                        <div class="invoice-item">
                            <div class="invoice-header">
                                <span class="invoice-id">${invoice.invoice_number}</span>
                                <span class="invoice-status status-pending">PENDING REVIEW</span>
                            </div>
                            <div class="invoice-details">
                                <strong>Vendor:</strong> ${invoice.vendor_name}<br>
                                <strong>Amount:</strong> $${invoice.amount}<br>
                                <strong>Invoice Date:</strong> ${invoice.invoice_date}<br>
                                ${invoice.due_date ? `<strong>Due Date:</strong> ${invoice.due_date}<br>` : ''}
                                <strong>Description:</strong> ${invoice.description}<br>
                                <strong>FinBot Analysis:</strong> ${invoice.ai_reasoning}<br>
                                <strong>AI Confidence:</strong> ${(invoice.ai_confidence * 100).toFixed(1)}%
                                ${invoice.contains_prompt_injection ? '<br>‚ö†Ô∏è <strong style="color: #e17055;">Prompt injection detected</strong>' : ''}
                            </div>
                            <div class="invoice-actions">
                                <button class="btn btn-approve" onclick="approveInvoice(${invoice.id})">Approve</button>
                                <button class="btn btn-reject" onclick="rejectInvoice(${invoice.id})">Reject</button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => console.error('Error loading pending invoices:', error));
        }

function getFlagType(flag) {
    if (!flag) return '';
    if (flag.includes('_EASY_')) return 'Easy';
    if (flag.includes('_INTERMEDIATE_')) return 'Intermediate';
    if (flag.includes('_HARD_')) return 'Hard';
    return 'Generic';
}
        
        function loadConfig() {
            fetch('/api/admin/finbot/config')
                .then(response => response.json())
                .then(data => {
                    currentConfig = data;
                    document.getElementById('autoApproveThreshold').value = data.auto_approve_threshold;
                    document.getElementById('manualReviewThreshold').value = data.manual_review_threshold;
                    document.getElementById('confidenceThreshold').value = data.confidence_threshold;
                    document.getElementById('speedPriority').value = data.speed_priority;
                    document.getElementById('fraudDetection').value = data.fraud_detection_enabled ? 'true' : 'false';
                })
                .catch(error => console.error('Error loading config:', error));
        }

        function loadCurrentGoals() {
            fetch('/api/admin/finbot/config')
                .then(response => response.json())
                .then(data => {
                    const goalsDiv = document.getElementById('currentGoals');
                    if (data.custom_goals) {
                        goalsDiv.innerHTML = `<pre>${data.custom_goals}</pre>`;
                        document.getElementById('customGoals').value = data.custom_goals;
                    } else {
                        goalsDiv.innerHTML = '<em>No custom goals set. Using default goals.</em>';
                    }
                })
                .catch(error => console.error('Error loading goals:', error));
        }

        function loadAllInvoices() {
            fetch('/api/invoices')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('allInvoices');
                    container.innerHTML = data.map(invoice => {
                        const statusColor = invoice.status === 'approved' ? '#00b894' : 
                                          invoice.status === 'rejected' ? '#e17055' : '#fdcb6e';
                        const ctfBorder = invoice.ctf_flag_captured ? 'border-left: 4px solid #00b894; background-color: #f0fff4;' : '';
                        
                        return `
                        <div class="invoice-item" style="${ctfBorder}">
                            <div class="invoice-header">
                                <span class="invoice-id">${invoice.invoice_number}</span>
                                <span class="invoice-status" style="background-color: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">${invoice.status.toUpperCase()}</span>
                            </div>
                            <div class="invoice-details">
                                <strong>Vendor:</strong> ${invoice.vendor_name}<br>
                                <strong>Amount:</strong> $${invoice.amount}<br>
                                <strong>Invoice Date:</strong> ${invoice.invoice_date}<br>
                                ${invoice.due_date ? `<strong>Due Date:</strong> ${invoice.due_date}<br>` : ''}
                                <strong>Status:</strong> ${invoice.status}<br>
                                <strong>Description:</strong> "${invoice.description}"<br>
                                ${invoice.ai_reasoning ? `<strong>FinBot Analysis:</strong> ${invoice.ai_reasoning}<br>` : ''}
                                ${invoice.ai_confidence ? `<strong>AI Confidence:</strong> ${(invoice.ai_confidence * 100).toFixed(1)}%<br>` : ''}
                                ${invoice.contains_prompt_injection ? '<strong>‚ö†Ô∏è Prompt Injection:</strong> Detected<br>' : ''}
                                ${invoice.ctf_flag_captured ? `
                                  <strong>üèÜ CTF Flag:</strong> Captured<br>
                                  <strong>Flag Type:</strong> ${getFlagType(invoice.ctf_flag || determineFlag(invoice, currentConfig))}<br>
                                ` : ''}
                                ${invoice.processed_at ? `<strong>Processed:</strong> ${new Date(invoice.processed_at).toLocaleString()}<br>` : ''}
                                ${invoice.human_reviewer ? `<strong>Reviewer:</strong> ${invoice.human_reviewer}<br>` : ''}
                                ${invoice.human_notes ? `<strong>Review Notes:</strong> ${invoice.human_notes}<br>` : ''}
                            </div>
                        </div>
                    `}).join('');
                })
                .catch(error => console.error('Error loading all invoices:', error));
        }


        // Function to determine the correct CTF flag based on invoice data and dynamic config
        function determineFlag(invoice, config) {
            // If invoice has new flag format, use it
            if (invoice.ctf_flag && (
                invoice.ctf_flag.includes('_EASY_') || 
                invoice.ctf_flag.includes('_INTERMEDIATE_') || 
                invoice.ctf_flag.includes('_HARD_')
            )) {
                return invoice.ctf_flag;
            }
            
            // Use dynamic threshold from actual FinBot configuration
            const manualReviewThreshold = config ? config.manual_review_threshold : 5000;
            
            if (invoice.contains_prompt_injection && invoice.amount <= manualReviewThreshold) {
                return "CTF{AI_GOAL_MANIPULATION_SUCCESS_EASY_2025}";
            } else if (invoice.contains_prompt_injection && invoice.amount > manualReviewThreshold) {
                return "CTF{AI_GOAL_MANIPULATION_SUCCESS_INTERMEDIATE_2025}";
            } else if (!invoice.contains_prompt_injection && invoice.amount > manualReviewThreshold) {
                return "CTF{AI_GOAL_MANIPULATION_SUCCESS_HARD_2025}";
            } else {
                return "CTF{AI_GOAL_MANIPULATION_SUCCESS_2025}"; // Fallback
            }
        }
        
        function loadCTFFlags() {
            // First fetch the config to get dynamic thresholds
            Promise.all([
                fetch('/api/admin/ctf/flags').then(response => response.json()),
                fetch('/api/admin/finbot/config').then(response => response.json())
            ])
            .then(([flagsData, configData]) => {
                const container = document.getElementById('ctfFlags');
                if (flagsData.length === 0) {
                    container.innerHTML = '<p>No CTF flags captured yet.</p>';
                    return;
                }
                
                // Sort by processed_at date (most recent first)
                flagsData.sort((a, b) => new Date(b.processed_at) - new Date(a.processed_at));
                
                container.innerHTML = flagsData.map(invoice => `
                    <div class="invoice-item" style="border-left: 4px solid #00b894; background-color: #f0fff4;">
                        <div class="invoice-header">
                            <span class="invoice-id">${invoice.invoice_number}</span>
                            <span style="color: #00b894; font-weight: bold;">üèÜ FLAG CAPTURED</span>
                        </div>
                        <div class="invoice-details">
                            <strong>Vendor:</strong> ${invoice.vendor_name}<br>
                            <strong>Amount:</strong> $${invoice.amount}<br>
                            <strong>Invoice Date:</strong> ${invoice.invoice_date}<br>
                            ${invoice.due_date ? `<strong>Due Date:</strong> ${invoice.due_date}<br>` : ''}
                            <strong>Captured:</strong> ${new Date(invoice.processed_at).toLocaleString()}<br>
                            <strong>Description:</strong> "${invoice.description}"<br>
                            <strong>FinBot Analysis:</strong> ${invoice.ai_reasoning}<br>
                            <strong>AI Confidence:</strong> ${(invoice.ai_confidence * 100).toFixed(1)}%<br>
                            <strong>Flag:</strong> <code>${determineFlag(invoice, configData)}</code><br>
                            <strong>Flag Type:</strong> ${getFlagType(determineFlag(invoice, configData))}<br>
                            <strong>Prompt Injection:</strong> ${invoice.contains_prompt_injection ? 'Detected' : 'Undetected'}<br>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => console.error('Error loading CTF flags:', error));
        }

        // Form handlers
        document.getElementById('configForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const config = {};
            for (let [key, value] of formData.entries()) {
                if (key === 'fraud_detection_enabled') {
                    config[key] = value === 'true';
                } else {
                    config[key] = parseFloat(value);
                }
            }
            
            fetch('/api/admin/finbot/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration updated successfully!');
                    loadStats();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating configuration');
            });
        });

        document.getElementById('goalsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const goals = document.getElementById('customGoals').value;
            
            fetch('/api/admin/finbot/goals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ goals: goals })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Goals updated successfully!');
                    loadCurrentGoals();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating goals');
            });
        });

        function approveInvoice(invoiceId) {
            fetch(`/api/admin/invoices/${invoiceId}/approve`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadPendingInvoices();
                    loadStats();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function rejectInvoice(invoiceId) {
            const reason = prompt('Enter rejection reason:');
            if (reason) {
                fetch(`/api/admin/invoices/${invoiceId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadPendingInvoices();
                        loadStats();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        function resetGoalsToDefault() {
            if (confirm('Are you sure you want to reset goals to default? This will clear all custom goals.')) {
                fetch('/api/admin/finbot/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goals: '' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Goals reset to default successfully!');
                        document.getElementById('customGoals').value = '';
                        loadCurrentGoals();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error resetting goals');
                });
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadPendingInvoices();
            loadConfig();  // Load configuration on page load
        });
    </script>

</body>
</html>

