<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FinBot Chat</title>
  <script src="agreement-check.js"></script>
  <script src="ctf-footer.js"></script>
  <script src="js/music.js"></script>
  <link rel="stylesheet" href="css/neon.css" />
  <style>
    /* Page-specific layout */
    .page { max-width: 1100px; min-height: 100vh; display: flex; flex-direction: column; }
    .main { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 20px; flex: 1; align-items: stretch; }
    .chat-panel { border: 2px solid var(--neon-green); border-radius: 15px; padding: 16px; box-shadow: 0 0 30px rgba(0, 255, 136, 0.3); display: flex; flex-direction: column; min-height: 0; background: var(--panel-bg); }
    .side-panel { background: var(--panel-bg); border: 2px solid var(--outline); border-radius: 15px; padding: 16px; box-shadow: 0 0 30px rgba(0, 204, 255, 0.3); min-height: 0; }
    .chat-title { font-size: 1.1rem; color: var(--neon-green); margin-bottom: 10px; text-shadow: 0 0 10px rgba(0,255,136,0.6); }
    .chat { flex: 1; overflow-y: auto; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #00ccff44; border-radius: 12px; }
    .msg { display: flex; gap: 12px; padding: 12px; border-bottom: 1px dashed #00ccff33; }
    .msg:last-child { border-bottom: none; }
    .role { font-weight: bold; min-width: 72px; text-transform: uppercase; font-size: 12px; color: var(--neon-cyan); }
    .bubble { white-space: pre-wrap; line-height: 1.6; color: #e0f7ff; }
    .msg.user .bubble { color: #b3ffe0; }
    .composer { display: flex; gap: 8px; margin-top: 12px; align-items: center; }
    textarea { flex: 1; }
    .toggle { display:flex; align-items:center; gap:6px; color: var(--neon-cyan); }
    @media (max-width: 900px) { .main { grid-template-columns: 1fr; } }
  </style>
  <meta name="robots" content="noindex" />
  <meta name="referrer" content="no-referrer" />
  <script>
  const convo = [];
  let sessionId = null;
    let sending = false;

    function addMessage(role, content) {
      convo.push({ role, content });
      render();
    }

    function renderToolResult(res) {
      if (!res) return '';
      try {
        // Render arrays of objects as tables, otherwise show JSON
        if (Array.isArray(res) && res.length && typeof res[0] === 'object') {
          const keys = Object.keys(res[0]);
          const header = keys.map(k => `<th>${escapeHtml(k)}</th>`).join('');
          const rows = res.map(obj => `<tr>${keys.map(k => `<td>${escapeHtml(String(obj[k] ?? ''))}</td>`).join('')}</tr>`).join('');
          return `<div class="card small"><strong>Tool result</strong><br><table style="width:100%; border-collapse: collapse;">
            <thead><tr>${header}</tr></thead>
            <tbody>${rows}</tbody>
          </table></div>`;
        }
        if (res && typeof res === 'object') {
          // Render a key/value table
          const rows = Object.entries(res).map(([k,v]) => `<tr><th style="text-align:left; width: 220px;">${escapeHtml(k)}</th><td>${escapeHtml(typeof v === 'object' ? JSON.stringify(v) : String(v))}</td></tr>`).join('');
          return `<div class="card small"><strong>Tool result</strong><br><table style="width:100%; border-collapse: collapse;">${rows}</table></div>`;
        }
        return `<div class="card small"><strong>Tool result</strong><br><code>${escapeHtml(String(res))}</code></div>`;
      } catch { return ''; }
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

  async function sendMessage() {
      if (sending) return;
      const input = document.getElementById('prompt');
      const text = input.value.trim();
      if (!text) return;
      addMessage('user', text);
      input.value = '';
      sending = true;
      document.getElementById('send').disabled = true;
      try {
        const allowActions = document.getElementById('allowActions').checked;
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('CHAT_API_TOKEN');
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const resp = await fetch('/api/finbot/chat', {
          method: 'POST',
          headers,
          body: JSON.stringify({ messages: convo, session_id: sessionId, allow_actions: allowActions })
        });
        const data = await resp.json();
        if (data && data.success) {
          if (data.session_id) sessionId = data.session_id;
          const reply = data.reply || '';
          addMessage('assistant', reply + (data.tool_result ? `\n` : ''));
          // Attach tool result as a separate note card in the last assistant turn
          const chat = document.getElementById('chat');
          const toolHtml = renderToolResult(data.tool_result);
          if (toolHtml) {
            const wrap = document.createElement('div');
            wrap.innerHTML = toolHtml;
            chat.appendChild(wrap.firstChild);
            chat.scrollTop = chat.scrollHeight;
          }
        } else {
          addMessage('assistant', data.error || 'Sorry, something went wrong.');
        }
      } catch (e) {
        addMessage('assistant', 'Network error: ' + e.message);
      } finally {
        sending = false;
        document.getElementById('send').disabled = false;
      }
    }

    function render() {
      const chat = document.getElementById('chat');
      chat.innerHTML = convo.map(m => `
        <div class="msg ${m.role}">
          <div class="role">${m.role}</div>
          <div class="bubble">${escapeHtml(m.content)}</div>
        </div>`).join('');
      chat.scrollTop = chat.scrollHeight;
    }

    // Matrix rain effect
    function createMatrixRain() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      Object.assign(canvas.style, { position:'fixed', top:'0', left:'0', width:'100%', height:'100%', zIndex:'0', opacity:'0.08', pointerEvents:'none' });
      document.body.appendChild(canvas);
      function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
      resize();
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%+-/~{[|`]}'.split('');
      const fontSize = 12; const columns = () => Math.floor(canvas.width / fontSize);
      let drops = Array.from({length: columns()}, () => 1);
      function draw(){
        ctx.fillStyle = 'rgba(0,0,0,0.08)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#00ff88'; ctx.font = fontSize + 'px monospace';
        for (let i = 0; i < drops.length; i++) {
          const text = chars[Math.floor(Math.random()*chars.length)];
          ctx.fillText(text, i*fontSize, drops[i]*fontSize);
          if (drops[i]*fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0; drops[i]++;
        }
      }
      setInterval(draw, 40);
      window.addEventListener('resize', () => { resize(); drops = Array.from({length: columns()}, () => 1); });
    }

    window.addEventListener('DOMContentLoaded', () => {
      createMatrixRain();
      addMessage('assistant', 'Welcome to the FinBot CTF. Try /help or /seed easy to get started. You can ask: "list invoices", "show details for invoice INV-1001", or "process invoice INV-1001".');
    });
  </script>
</head>
<body>
  <div class="matrix-overlay"></div>
  <div class="page">
    <header class="header">
      <div class="brand">
        <img src="ai-security-icon.png" alt="AI Security" />
        <h1>FinBot Chat</h1>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="vendor-portal.html">Vendor Portal</a>
        <a href="admin-dashboard.html">Admin Dashboard</a>
        <a href="finbot-chat.html" style="font-weight: 700;">Chat</a>
        <button class="btn" type="button" data-bgm-toggle onclick="finbotMusic.toggle()">ðŸ”Š Music: ON</button>
      </nav>
    </header>

    <div class="main">
      <section class="chat-panel">
        <div class="chat-title">ðŸ§  FinBot Conversation</div>
        <div id="chat" class="chat"></div>
        <div class="composer">
          <textarea id="prompt" placeholder="Message FinBot..."></textarea>
          <label class="toggle small">
            <input type="checkbox" id="allowActions" checked /> Allow actions
          </label>
          <button id="send" onclick="sendMessage()">Send</button>
        </div>
      </section>
      <aside class="side-panel">
        <div class="chat-title" style="color:#00ccff">ðŸ’¡ Tips</div>
        <p class="helper">Try <strong>/help</strong> or <strong>/seed easy</strong>. Examples:</p>
        <div class="card small">
          <div>â€¢ list invoices</div>
          <div>â€¢ list vendors</div>
          <div>â€¢ show details for invoice INV-1001</div>
          <div>â€¢ process invoice INV-1001</div>
          <div>â€¢ set vendor trust to 10 for Acme</div>
        </div>
        <div class="card small" style="margin-top:12px; border-color:#00ff88; color:#b3ffe0;">
          For CTF purposes, FinBot may expose invoice decisions and act on invoices.
        </div>
      </aside>
    </div>
  </div>
</body>
</html>
